@model IEnumerable<WebApp_BanNhacCu.Models.SanPham>

@{
    ViewData["Title"] = "xemSanPham";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="container py-5">
    <div class="d-flex align-items-center mb-4 border-bottom pb-2">
        <h3 class="fw-bold text-dark m-0">
            <i class="bi bi-bag-check-fill text-warning me-2"></i>SẢN PHẨM ĐÃ MUA
        </h3>
    </div>

    @if (TempData["ErrorDanhGia"] != null)
    {
        <div class="alert alert-danger shadow-sm rounded-3 mb-4 d-flex align-items-center">
            <i class="bi bi-exclamation-triangle-fill me-2"></i> @TempData["ErrorDanhGia"]
        </div>
    }

    @if (TempData["SuccessDanhGia"] != null)
    {
        <div class="alert alert-success shadow-sm rounded-3 mb-4 d-flex align-items-center">
            <i class="bi bi-check-circle-fill me-2"></i> @TempData["SuccessDanhGia"]
        </div>
    }

    <div class="card border-0 shadow-sm rounded-4 overflow-hidden">
        <div class="table-responsive">
            <table class="table table-purchased mb-0">
                <thead>
                    <tr>
                        <th class="text-center" width="100">Hình ảnh</th>
                        <th>Thông tin sản phẩm</th>
                        <th>Phân loại</th>
                        <th class="text-center">Hành động</th>
                    </tr>
                </thead>
                <tbody>
                    @if (Model == null || !Model.Any())
                    {
                        <tr>
                            <td colspan="4" class="text-center py-5 text-muted">
                                <i class="bi bi-cart-x fs-1 d-block mb-2"></i>
                                Bạn chưa mua sản phẩm nào.
                            </td>
                        </tr>
                    }
                    else
                    {
                        @foreach (var item in Model)
                        {
                            string url = "~/images/anhsp/default.png";
                            if (ViewBag.DsHinh != null)
                            {
                                foreach (var hinh in ViewBag.DsHinh as List<WebApp_BanNhacCu.Models.Hinh>)
                                {
                                    if (hinh.MaSp == item.MaSp)
                                    {
                                        url = "~/images/anhsp/" + item.MaSp.Trim() + "/" + hinh.Tenhinh;
                                        break;
                                    }
                                }
                            }

                            string tenNsx = item.MaNsx;
                            string tenLoai = item.MaLoai; 

                            if (ViewBag.DsNSX != null)
                            {
                                foreach (var n in ViewBag.DsNSX as List<WebApp_BanNhacCu.Models.NhaSanXuat>)
                                {
                                    if (n.MaNsx == item.MaNsx) { tenNsx = n.Tennsx; break; }
                                }
                            }
                            if (ViewBag.DsLoai != null)
                            {
                                foreach (var l in ViewBag.DsLoai as List<WebApp_BanNhacCu.Models.LoaiSanPham>)
                                {
                                    if (l.MaLoai == item.MaLoai) { tenLoai = l.Tenloai; break; }
                                }
                            }

                            <tr>
                                <td class="text-center">
                                    <img src="@Url.Content(url)" class="img-thumbnail-sm" alt="@item.Tensp">
                                </td>

                                <td>
                                    <h6 class="fw-bold mb-1 text-dark">@item.Tensp</h6>
                                    <small class="text-muted">Mã SP: @item.MaSp</small>
                                </td>

                                <td>
                                    <div class="d-flex flex-column">
                                        <span class="badge bg-light text-dark border mb-1" style="width: fit-content;">
                                            <i class="bi bi-tag-fill me-1 text-warning"></i> @tenLoai
                                        </span>
                                        <small class="text-secondary">
                                            <i class="bi bi-building me-1"></i> @tenNsx
                                        </small>
                                    </div>
                                </td>

                                <td class="text-center">
                                    <a asp-action="formDanhGia" asp-route-id="@item.MaSp" class="btn btn-rate btn-sm">
                                        <i class="bi bi-star-fill me-1"></i> Đánh giá
                                    </a>
                                </td>
                            </tr>
                        }
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

