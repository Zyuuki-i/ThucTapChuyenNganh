@model IEnumerable<WebApp_BanNhacCu.Models.SanPham>

@{
    ViewData["Title"] = "Chi tiết sản phẩm";
    Layout = "~/Views/Shared/SanPham_Layout.cshtml";

    var sp = Model != null && Model.Any() ? Model.First() : null;
}

<nav aria-label="breadcrumb" class="mb-4">
    <ol class="breadcrumb breadcrumb-custom">
        <li class="breadcrumb-item">
            <a asp-controller="SanPham" asp-action="Index"><i class="bi bi-house-door-fill"></i> Trang chủ</a>
        </li>
        @if (sp != null)
        {
            <li class="breadcrumb-item">
                <a asp-controller="SanPham" asp-action="locNSX" asp-route-mansx="@sp.MaNsx"><span class="text-uppercase">@sp.MaNsx</span></a>
            </li>
            <li class="breadcrumb-item">
                <a asp-controller="SanPham" asp-action="locLoai" asp-route-maloai="@sp.MaLoai"><span class="text-uppercase">@sp.MaLoai</span></a>
            </li>
        }
    </ol>
</nav>

@if (TempData["MessageSuccess_GioHang"] != null)
{
    <div class="alert alert-success text-center fw-bold shadow-sm fade show mb-4">
        <i class="bi bi-check-circle-fill me-2"></i> @TempData["MessageSuccess_GioHang"]
    </div>
}
@if (TempData["MessageError_GioHang"] != null)
{
    <div class="alert alert-danger text-center fw-bold shadow-sm fade show mb-4">
        <i class="bi bi-exclamation-triangle-fill me-2"></i> @TempData["MessageError_GioHang"]
    </div>
}

@if (sp == null)
{
    <div class="text-center py-5">
        <h3 class="text-danger fw-bold">Sản phẩm không tồn tại!</h3>
        <a asp-action="Index" class="btn btn-outline-dark mt-3">Quay lại trang chủ</a>
    </div>
}
else
{
    <div class="row g-5 align-items-start">
        
        <div class="col-lg-6">
            @{
                List<Hinh> dsHinh = ViewBag.HinhChinh;
                string mainImgUrl = "~/images/anhsp/default.png";
                if (dsHinh != null && dsHinh.Count > 0)
                {
                    mainImgUrl = "~/images/anhsp/" + sp.MaSp.Trim() + "/" + dsHinh[0].Tenhinh;
                }
            }
            
            <div class="main-image-frame mb-3" style="height: 400px;">
                <img id="anhChinh" src="@Url.Content(mainImgUrl)" class="img-fluid" alt="@sp.Tensp" style="max-height: 100%; object-fit: contain;">
            </div>

            @if (dsHinh != null && dsHinh.Count > 0)
            {
                <div class="thumb-list">
                    @for (int i = 0; i < dsHinh.Count; i++)
                    {
                        var hinh = dsHinh[i];
                        string thumbUrl = "~/images/anhsp/" + sp.MaSp.Trim() + "/" + hinh.Tenhinh;
                        <img src="@Url.Content(thumbUrl)" class="thumb-img @(i == 0 ? "active" : "")" onclick="changeImage(this)" alt="Thumbnail">
                    }
                </div>
            }
        </div>

        <div class="col-lg-6">
            <h2 class="fw-bold mb-2">@sp.Tensp</h2>
            
            <div class="mb-3 d-flex align-items-center">
                <div class="text-warning me-2">
                    @{
                        List<DanhGia> dsdg = ViewBag.DanhGia;
                        int countReview = (dsdg != null) ? dsdg.Count : 0;
                        if (dsdg != null && countReview > 0)
                        {
                            double tongdiem = dsdg.Where(d => d.Sosao.HasValue).Sum(d => d.Sosao.Value);
                            double diemTB = tongdiem / countReview;
                            int sao = (int)Math.Round(diemTB);
                            
                            for (int i = 1; i <= 5; i++)
                            {
                                <i class="bi @(i <= sao ? "bi-star-fill" : "bi-star")"></i>
                            }
                        }
                        else
                        {
                            <i class="bi bi-star text-muted"></i><i class="bi bi-star text-muted"></i><i class="bi bi-star text-muted"></i><i class="bi bi-star text-muted"></i><i class="bi bi-star text-muted"></i>
                        }
                    }
                </div>
                <span class="text-muted small">(@countReview đánh giá)</span>
            </div>

            <div class="mb-4">
                @{
                    List<NhaSanXuat> dsnx = ViewBag.DsNSX;
                    var nsx = dsnx.FirstOrDefault(n => n.MaNsx == sp.MaNsx);
                    string brandName = nsx != null ? nsx.Tennsx : "Unknown";
                }
                <p class="mb-1">Thương hiệu: <span class="fw-semibold text-dark">@brandName</span></p>
                <p class="mb-1">
                    Tình trạng: 
                    @if (sp.Soluongton > 0)
                    {
                        <span class="badge bg-success bg-opacity-10 text-success px-3">Còn hàng</span>
                    }
                    else
                    {
                        <span class="badge bg-danger bg-opacity-10 text-danger px-3">Hết hàng</span>
                    }
                </p>
            </div>

            <div class="mb-4 p-3 bg-light rounded-3">
                <span class="text-danger fw-bold display-6 me-3">@String.Format("{0:N0} đ", sp.Giasp)</span>
                <span class="text-muted text-decoration-line-through fs-5">@String.Format("{0:N0} đ", (sp.Giasp * 1.18m))</span>
            </div>

            <p class="text-secondary mb-4">
                @sp.Mota
            </p>

            <div class="d-flex align-items-center mb-4">
                <span class="me-3 fw-semibold">Số lượng:</span>
                <div class="input-group quantity-group" style="width: 140px;">
                    <button class="btn btn-outline-secondary btn-giam" type="button"><i class="bi bi-dash"></i></button>
                    <input type="text" class="form-control text-center soluong" value="1" min="1">
                    <button class="btn btn-outline-secondary btn-tang" type="button"><i class="bi bi-plus"></i></button>
                </div>
            </div>

            <div class="d-flex gap-3 flex-column flex-sm-row">
                <form asp-controller="DonDatHang" asp-action="muaNgay" asp-route-id="@sp.MaSp" method="post" class="flex-fill">
                    <input type="hidden" name="soluong" class="sl-hidden" value="1" />
                    <button type="submit" class="btn btn-buy-now-lg w-100 btn-action-lg d-flex flex-column justify-content-center align-items-center">
                        <span class="fw-bold fs-5 text-uppercase">Mua Ngay</span>
                        <span class="small fw-normal">Giao hàng tận nơi</span>
                    </button>
                </form>
                
                <form asp-controller="DonDatHang" asp-action="themVaoGio" asp-route-id="@sp.MaSp" method="post" class="flex-fill">
                    <input type="hidden" name="soluong" class="sl-hidden" value="1" />
                    <button type="submit" class="btn btn-add-cart-lg w-100 btn-action-lg d-flex flex-column justify-content-center align-items-center">
                        <span class="fw-bold fs-5 text-uppercase">Thêm vào giỏ</span>
                        <span class="small fw-normal">Tìm thêm sản phẩm khác</span>
                    </button>
                </form>
            </div>
        </div>
    </div>

    <hr class="my-5 text-secondary opacity-25" />

    <div class="row">
        <div class="col-lg-8">
            <h4 class="fw-bold mb-4 border-start border-4 border-warning ps-3">Đánh giá từ khách hàng</h4>
            
            @if (dsdg == null || dsdg.Count <= 0)
            {
                <div class="text-center py-4 bg-light rounded-3">
                    <i class="bi bi-chat-square-dots text-muted fs-1"></i>
                    <p class="text-muted mt-2">Chưa có đánh giá nào cho sản phẩm này.</p>
                </div>
            }
            else
            {
                List<NguoiDung> dskh = ViewBag.KhachHangDanhGia;
                <div class="review-list" style="max-height: 500px; overflow-y: auto;">
                    @foreach (var dg in dsdg)
                    {
                        var kh = dskh.FirstOrDefault(k => k.MaNd == dg.MaNd);
                        <div class="review-item d-flex gap-3">
                            @{ string avatarUrl = "~/images/anhdaidien/default-user.png";}
                            <div class="flex-shrink-0">
                                <div class="bg-secondary text-white rounded-circle d-flex align-items-center justify-content-center fw-bold" style="width: 50px; height: 50px;">
                                    @(kh != null ? kh.Tennd.Substring(0,1).ToUpper() : "U")
                                </div>
                            </div>
                            
                            <div>
                                <h6 class="fw-bold mb-1">@(kh != null ? kh.Tennd : "Người dùng ẩn danh")</h6>
                                <div class="text-warning small mb-2">
                                    @for (int i = 1; i <= (dg.Sosao ?? 0); i++) { <i class="bi bi-star-fill"></i> }
                                    @for (int i = (dg.Sosao ?? 0) + 1; i <= 5; i++) { <i class="bi bi-star"></i> }
                                </div>
                                <p class="mb-0 text-dark">@dg.Noidung</p>
                            </div>
                        </div>
                    }
                </div>
            }
        </div>
    </div>

    <div class="mt-5">
        <h4 class="fw-bold mb-4 border-start border-4 border-warning ps-3">Sản phẩm tương tự</h4>
        
        <div class="d-flex overflow-auto pb-4 gap-4" style="scroll-snap-type: x mandatory;">
            @foreach (var item in Model)
            {
                string tenfile = "";
                List<Hinh> dsHinhAll = ViewBag.DsHinh;
                var hinhItem = dsHinhAll.FirstOrDefault(h => h.MaSp == item.MaSp);
                string urlItem = (hinhItem != null && hinhItem.Tenhinh != null) ? "~/images/anhsp/" + item.MaSp.Trim() + "/" + hinhItem.Tenhinh : "~/images/anhsp/default.png";

                <div class="flex-shrink-0" style="width: 280px; scroll-snap-align: start;">
                    <div class="card h-100 product-card shadow-sm border-0 rounded-3">
                        <a asp-controller="SanPham" asp-action="chiTiet" asp-route-id="@item.MaSp" class="text-decoration-none">
                            <div class="card-img-wrapper border-bottom position-relative pt-100" style="padding-top: 100%; position: relative; overflow: hidden;">
                                <img src="@Url.Content(urlItem)" alt="@item.Tensp" style="width: 100%; height: 100%; object-fit: contain;">
                            </div>
                        </a>
                        <div class="card-body p-3">
                            <h6 class="card-title text-truncate mb-2">
                                <a asp-controller="SanPham" asp-action="chiTiet" asp-route-id="@item.MaSp" class="text-dark text-decoration-none">@item.Tensp</a>
                            </h6>
                            <div class="text-danger fw-bold">@String.Format("{0:N0} đ", item.Giasp)</div>
                            <a asp-controller="DonDatHang" asp-action="themVaoGio" asp-route-id="@item.MaSp" class="btn btn-sm btn-outline-dark w-100 mt-2 rounded-pill">
                                <i class="bi bi-cart-plus me-1"></i> Thêm Vào Giỏ
                            </a>
                        </div>
                    </div>
                </div>
            }
        </div>
    </div>
}

<script>

    function changeImage(element) {
        document.getElementById("anhChinh").src = element.src;

        document.querySelectorAll(".thumb-img").forEach(el => el.classList.remove("active"));

        element.classList.add("active");
    }

    document.addEventListener("DOMContentLoaded", function () {
        const btnGiam = document.querySelector(".btn-giam");
        const btnTang = document.querySelector(".btn-tang");
        const inputSL = document.querySelector(".soluong");
        const hiddenInputs = document.querySelectorAll(".sl-hidden"); 

        function updateQuantity(val) {
            inputSL.value = val;
            hiddenInputs.forEach(input => input.value = val);
        }

        if(btnTang && btnGiam && inputSL) {
            btnGiam.addEventListener("click", () => {
                let val = parseInt(inputSL.value) || 1;
                if (val > 1) updateQuantity(val - 1);
            });

            btnTang.addEventListener("click", () => {
                let val = parseInt(inputSL.value) || 1;
                updateQuantity(val + 1);
            });

            inputSL.addEventListener("change", () => {
                let val = parseInt(inputSL.value) || 1;
                if (val < 1) val = 1;
                updateQuantity(val);
            });
        }
        

        const alertBox = document.querySelector(".alert");
        if (alertBox) {
            setTimeout(() => {
                alertBox.classList.remove("show");
                setTimeout(() => alertBox.remove(), 500); 
            }, 3000);
        }
    });
</script>