@model IEnumerable<WebApp_BanNhacCu.Models.ChiTietDonDatHang>

@{
    ViewData["Title"] = "Giỏ hàng";
    Layout = "~/Views/Shared/_Layout.cshtml";
    var userEmail = Context.Session.GetString("UserEmail");
}

<h1 class="text-uppercase fw-bold mt-4"><i class="bi bi-cart"></i> Giỏ hàng của bạn</h1>
<hr/>
@if (TempData["MessageError_DonHang"] != null)
{
    <div class="alert alert-danger text-center fw-bold">
        @TempData["MessageError_DonHang"] 
    </div>
}
@if (!Model.Any())
{
    <h2 class="text-secondary text-center mt-5">Giỏ hàng của bạn đang trống.</h2>
    <div class="w-100 text-center">
        <a class="text-decoration-none fs-4 text-success" asp-controller="SanPham" asp-action="Index">Xem thêm nhiều sản phẩm</a>
    </div>
}
else
{
    <div class="row">
        <div class="col-sm-8">
            <table class="table table-bordered text-center">
                <thead>
                    <tr>
                        <th>STT</th>
                        <th>Ảnh</th>
                        <th>Sản phẩm</th>
                        <th>Số lượng</th>
                        <th>Đơn giá</th>
                        <th>Thành tiền</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    @{
                        List <Hinh> dsHinh = ViewBag.DsHinh;
                        int stt = 0;
                    }
                    @foreach (var item in Model)
                    {
                        var hinhSp = dsHinh.FirstOrDefault(h => h.MaSp.Trim() == item.MaSp.Trim());
                        string tenfile = hinhSp?.Tenhinh ?? "";
                        string url = tenfile == "" 
                            ? "~/images/anhsp/default.png"
                            : "~/images/anhsp/" + item.MaSp.Trim() + "/" + tenfile;
                        <tr>
                            <td>@(++stt)</td>
                            <td>
                                <div class="d-flex justify-content-center align-items-center">
                                    <img src="@Url.Content(url)" alt="@item.MaSpNavigation.Tensp" class="rounded-3 me-2" style="width: 40px; height: 40px; object-fit: cover;">
                                </div>
                            </td>
                            <td>@item.MaSpNavigation.Tensp</td>
                            <td>
                                <div class="d-flex justify-content-center align-items-center">
                                    <form asp-action="giamSL" asp-route-id="@item.MaSp" method="post">
                                        <button type="submit" class="btn-giam btn btn-outline-secondary">-</button>
                                    </form>
                                    <form asp-action="capNhatSL" asp-route-id="@item.MaSp" method="post" id="form-capNhatSL">
                                        <input type="text" name="sl" class="soluong form-control text-center mx-2" value="@item.Soluong" style="width: 60px;">
                                    </form>
                                    <form asp-action="tangSL" asp-route-id="@item.MaSp" method="post">
                                        <button type="submit" class="btn-tang btn btn-outline-secondary">+</button>
                                    </form>
                                </div>
                            </td>
                            <td>@String.Format("{0:N0}",item.Gia)đ</td>
                            <td class="text-danger">@String.Format("{0:N0}",(item.Soluong * item.Gia))đ</td>
                            <td><a asp-controller="DonDatHang" asp-action="xoaKhoiGio" asp-route-id="@item.MaSp"><i class="bi bi-trash text-danger"></i></a></td>
                        </tr>
                    }
                </tbody>
            </table>
            <script>
                document.addEventListener("DOMContentLoaded", function () {
                    const giam = document.querySelector(".btn-giam");
                    const tang = document.querySelector(".btn-tang");
                    const input = document.querySelector(".soluong");

                    function capNhat(gtri) {
                        input.value = gtri;
                    }

                    giam.addEventListener("click", function () {
                        let y = parseInt(input.value) || 1;
                        if (y > 1) capNhat(y - 1);
                    });

                    tang.addEventListener("click", function () {
                        let x = parseInt(input.value) || 1;
                        capNhat(x + 1);
                    });

                    input.addEventListener("input", function () {
                        let gtri = parseInt(input.value) || 1;
                        if (gtri < 1) gtri = 1;
                        capNhat(gtri);
                    });
                });
            </script>
        </div>
        <div class="col-sm-4">
            <h3>Thông tin đơn hàng</h3>
            <hr/>
            <div class="d-flex flex-row justify-content-between mb-3">
                <strong>Số sản phẩm:</strong>
                <span class="text-danger">@Model.Sum(i => i.Soluong)</span>
            </div>
            <div class="d-flex flex-row justify-content-between mb-3">
                <strong>Tổng tiền:</strong>
                <span class="text-danger fs-5">@String.Format("{0:N0}", @Model.Sum(i => i.Soluong * i.Gia))đ</span>
            </div>
            <div>
                <p class="form-control text-secondary fs-6 mb-4" readonly>Nhấn "<strong>Thanh toán</strong>" đồng nghĩa với việc bạn đồng ý tuân theo <a class="text-decoration-none text-danger" asp-controller="Home" asp-action="Privacy">Điều khoản & Chính sách</a> của đơn vị</p>
            </div>
            <form asp-controller="DonDatHang" asp-action="thanhToan" method="post">
                <input type="hidden" name="user" value="@userEmail" />
                <button class="btn btn-outline-success w-100" type="submit">Thanh toán</button>
            </form>
            @if (TempData["MessageSuccess_DonHang"] != null)
            {
                <div class="alert alert-success text-center fw-bold">
                    @TempData["MessageSuccess_DonHang"]
                </div>
            }
        </div>
    </div>
}
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const alertBox = document.querySelector(".alert");
        if (alertBox) {
            setTimeout(() => alertBox.style.display = "none", 3000);
        }
    });
</script>
