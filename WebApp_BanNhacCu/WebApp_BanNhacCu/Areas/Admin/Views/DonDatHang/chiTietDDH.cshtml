@model WebApp_BanNhacCu.Models.DonDatHang
@{
    ViewData["Title"] = "Chi tiết đơn hàng";
    var shipperDangXem = ViewBag.NV as NhanVien;
    Layout = "~/Areas/Admin/Views/Shared/_AdminLayout.cshtml";

    string statusClass = "bg-secondary";
    string iconStatus = "bi-clipboard";

    string tt = Model.Trangthai?.ToLower() ?? "";
    if (tt.Contains("thành"))
    {
        statusClass = "bg-success";
        iconStatus = "bi-check-circle-fill";
    }
    else if (tt.Contains("hủy"))
    {
        statusClass = "bg-danger";
        iconStatus = "bi-x-circle-fill";
    }
    else if (tt.Contains("đang xử lý"))
    {
        statusClass = "bg-warning text-dark";
        iconStatus = "bi-truck";
    }
    else if (tt.Contains("đã xử lý"))
    {
        statusClass = "bg-primary";
        iconStatus = "bi-hourglass-split";
    }

    string payClass = "text-danger";
    string payIcon = "bi-x-circle-fill";
    string payText = Model.TtThanhtoan ?? "Chưa thanh toán";

    if (payText.ToLower().Contains("đã"))
    {
        payClass = "text-success";
        payIcon = "bi-check-circle-fill";
    }
}

<div class="container py-4" id="invoice-content">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <div class="d-flex align-items-center gap-3">
                <h2 class="text-primary mb-0"><i class="bi bi-receipt"></i> Đơn hàng #@Model.MaDdh</h2>

                <span class="badge rounded-pill @statusClass fs-6 shadow-sm">
                    <i class="bi @iconStatus"></i> @Model.Trangthai
                </span>
            </div>
            <small class="text-muted ms-1">Ngày đặt: @(Model.Ngaydat.HasValue? Model.Ngaydat.Value.ToString("dd/MM/yyyy HH:mm") : "N/A")</small>
        </div>
        <div>
            @if ((Model.Trangthai?.ToLower() ?? "").ToLower().Contains("hoàn thành"))
            {
                <a href="javascript:window.print()" class="btn btn-outline-secondary me-2">
                    <i class="bi bi-printer"></i> In đơn
                </a>
            }
            <a asp-action="Index" class="btn btn-primary">
                <i class="bi bi-arrow-left"></i> Quay lại
            </a>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card h-100 shadow-sm border-start border-4 border-info">
                <div class="card-header bg-white fw-bold text-info">
                    <i class="bi bi-person-circle"></i> THÔNG TIN NGƯỜI ĐẶT
                </div>
                <div class="card-body">
                    @if (Model.MaNdNavigation != null)
                    {
                        <p class="mb-1"><strong>Họ tên:</strong> @Model.MaNdNavigation.Tennd</p>
                        <p class="mb-1"><strong>Email:</strong> @Model.MaNdNavigation.Email</p>
                        <p class="mb-1"><strong>Số điện thoại:</strong> @(Model.MaNdNavigation.Sdt ?? "Chưa cập nhật")</p>
                        <p class="mb-0"><strong>Địa chỉ:</strong> @(Model.MaNdNavigation.Diachi + ", " + Model.Phuongxa + ", " + Model.Tinhthanh ?? "Chưa cập nhật")</p>
                    }
                    else
                    {
                        <span class="text-muted">Không tìm thấy thông tin người dùng.</span>
                    }
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card h-100 shadow-sm border-start border-4 border-success">
                <div class="card-header bg-white fw-bold text-success">
                    <i class="bi bi-truck"></i> THÔNG TIN NGƯỜI NHẬN
                </div>
                <div class="card-body">
                    <p class="mb-1"><strong>Người nhận:</strong> @(Model.Nguoinhan ?? "Người đặt")</p>
                    <p class="mb-1"><strong>Số điện thoại:</strong> @Model.Sdt</p>
                    <p class="mb-1"><strong>Địa chỉ giao nhận:</strong> @Model.Diachi, @Model.Phuongxa, @Model.Tinhthanh</p>
                    <hr />
                    <div class="bg-light p-2 rounded border mt-2">
                        <div class="d-flex justify-content-between">
                            <span>Phương thức:</span>
                            <strong class="text-danger">@Model.Phuongthuc</strong>
                        </div>
                        <div class="d-flex justify-content-between mt-1">
                            <span>Trạng thái thanh toán:</span>
                            <strong class="@payClass">
                                <i class="bi @payIcon"></i> @payText
                            </strong>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="card shadow-sm mb-4">
        <div class="card-header bg-light fw-bold">
            <i class="bi bi-box-seam"></i> CHI TIẾT SẢN PHẨM
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-striped table-hover mb-0 align-middle">
                    <thead class="table-dark">
                        <tr>
                            <th class="text-center" width="5%">STT</th>
                            <th width="45%">Tên Sản Phẩm</th>
                            <th class="text-center" width="15%">Đơn giá</th>
                            <th class="text-center" width="15%">Số lượng</th>
                            <th class="text-end pe-4" width="20%">Thành tiền</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (Model.ChiTietDonDatHangs != null && Model.ChiTietDonDatHangs.Any())
                        {
                            int stt = 1;
                            foreach (var item in Model.ChiTietDonDatHangs)
                            {
                                <tr>
                                    <td class="text-center">@stt</td>
                                    <td>
                                        <span class="fw-bold text-dark">
                                            @(item.MaSpNavigation?.Tensp ?? "Sản phẩm " + item.MaSp)
                                        </span>
                                        <br />
                                        <small class="text-muted">Mã SP: @item.MaSp</small>
                                    </td>
                                    <td class="text-center">@item.Gia.ToString("N0") đ</td>
                                    <td class="text-center">
                                        <span class="badge bg-light text-dark border">x @item.Soluong</span>
                                    </td>
                                    <td class="text-end pe-4 fw-bold">
                                        @((item.Thanhtien ?? (item.Gia * item.Soluong)).ToString("N0")) đ
                                    </td>
                                </tr>
                                stt++;
                            }
                        }
                        else
                        {
                            <tr>
                                <td colspan="5" class="text-center text-muted py-3">Chưa có sản phẩm nào trong đơn hàng.</td>
                            </tr>
                        }
                    </tbody>
                    <tfoot class="bg-light">
                        <tr>
                            <td colspan="4" class="text-end fw-bold pt-3">TỔNG CỘNG:</td>
                            <td class="text-end pe-4 pt-3 text-danger fs-5 fw-bold">
                                @(Model.Tongtien.HasValue? Model.Tongtien.Value.ToString("N0") : "0") đ
                            </td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            <div class="alert alert-secondary d-flex justify-content-between align-items-center">
                <div>
                    <i class="bi bi-person-badge"></i>
                    <strong>Nhân viên phụ trách đơn:</strong>
                    @(Model.MaNvNavigation?.Tennv ?? "Chưa phân công")
                    @(Model.MaNvNavigation != null ? $"({Model.MaNvNavigation.MaNv})" : "")
                </div>

                @if (shipperDangXem != null)
                {
                    <div class="text-muted fst-italic">
                        <small>Đang xem bởi: @shipperDangXem.Tennv</small>
                    </div>
                }
            </div>
        </div>
    </div>
</div>

<style>
    @@media print {
        body * {
            visibility: hidden;
        }

        #invoice-content, #invoice-content * {
            visibility: visible;
        }

        #invoice-content {
            position: absolute;
            left: 0;
            top: 0;
            width: 100% !important;
            margin: 0 !important;
            padding: 10px !important;
        }

        .btn, .btn-primary, .btn-outline-secondary, header, footer {
            display: none !important;
        }

        .card {
            box-shadow: none !important;
            border: 1px solid #000 !important;
        }

        * {
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
        }
    }
</style>