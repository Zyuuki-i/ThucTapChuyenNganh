@{
    ViewData["Title"] = "Index";
    Layout = "~/Areas/Admin/Views/Shared/_AdminLayout.cshtml";
}

<h1 class="m-3 text-center">Quản Lý Đơn Đặt Hàng</h1>
@if (TempData["MessageError_DonHang"] != null)
{
    <div class="alert alert-danger text-center fw-bold">
        @TempData["MessageError_DonHang"]
    </div>
}
@if (TempData["MessageSuccess_DonHang"] != null)
{
    <div class="alert alert-success text-center fw-bold">
        @TempData["MessageSuccess_DonHang"]
    </div>
}
<div class="row align-items-center ms-4 mt-3 mb-3">
    <form id="formLocDonHang" class="row col-9">
        <div class="col-md-4 mt-0">
            <select name="trangthai" class="form-select" onchange=loadDonHang()>
                <option value="">Tất cả</option>
                <option value="Chờ xác nhận">Chờ xác nhận</option>
                <option value="Đang xử lý">Đang xử lý</option>
                <option value="Đã xử lý">Đã xử lý</option>
                <option value="Hoàn thành">Hoàn thành</option>
                <option value="Đã hủy">Đã hủy</option>
            </select>
        </div>

        <div class="col-md-3 mt-0">
            <select name="thang" class="form-select" onchange="loadDonHang()">
                <option value="0">Tất cả</option>
                @for (int i = 1; i <= 12; i++)
                {
                    <option value="@i">Tháng @i</option>
                }
            </select>
        </div>
    </form>
    <div class="col-3">
        <form class="d-flex search-group" id="formTimKiem" onsubmit="timDonHang(event)">
            <div class="input-group">
                <input class="form-control" type="search" name="keyword" placeholder="Nhập mã đơn..." aria-label="Search">
                <button class="btn btn-search" type="button"><i class="bi bi-search"></i></button>
            </div>
        </form>
    </div>
</div>
<div id="dsDonHang"></div>
<script src="~/lib/jquery/jquery.min.js"></script>
@section scripts {
<script>
    function timDonHang(event) {
        if(event) event.preventDefault();

        let maddh = document.forms["formTimKiem"]["keyword"].value;
        const dsDon = document.getElementById("dsDonHang");

        if (!maddh || maddh.trim() === "") {
            loadDonHang();
            return;
        }

        const xhttp = new XMLHttpRequest();
        xhttp.onload = function() {
            dsDon.innerHTML = this.responseText;
        };
        let url = `/Admin/DonDatHang/timKiem?maddh=${encodeURIComponent(maddh)}`;
        xhttp.open("GET", url, true);
        xhttp.send();
    }
    function loadDonHang(trang = 1) {
        let trangthai = document.forms["formLocDonHang"]["trangthai"].value;
        let thang = document.forms["formLocDonHang"]["thang"].value;
        const dsDon = document.getElementById("dsDonHang");
        const xhttp = new XMLHttpRequest();
        xhttp.onload = function() {
            dsDon.innerHTML = this.responseText;
        };
        let url = `/Admin/DonDatHang/IndexAjax?trangthai=${encodeURIComponent(trangthai)}&thang=${thang}&trang=${trang}`;
        xhttp.open("GET", url, true);
        xhttp.send();
    }

    $(document).ready(function () {
        let thang = "@ViewBag.thang";
        document.forms["formLocDonHang"]["thang"].value = thang;
        loadDonHang();
    });
    const alertBox = document.querySelector(".alert");
    if (alertBox) {
        setTimeout(() => alertBox.style.display = "none", 3000);
    }
</script>
}